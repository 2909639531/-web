<!--我们首先引入模板，以后我可能会引入宏macro-->
{% extends 'base.html' %}

<!--替换标题-->
{% block title %}管理页面{% endblock %}

<!--替换正文-->
{% block body %}

    <div class="container" style="margin-top: 100px">
        <div class="panel panel-default">
            <div class="panel-heading">数据库同步工具</div>
            <div class="panel-body">
                <p>点击下面的按钮，系统会自动扫描 `static/images` 文件夹，并将尚未记录到数据库中的图片添加进来。</p>
                <form action="{{ url_for('sync_images') }}" method="post">
                    <button type="submit" class="btn btn-primary">开始同步文件夹图片</button>
                </form>
            </div>
        </div>
        <div class="panel panel-default">
            {% with messages = get_flashed_messages(with_categories=True) %}
                {% if messages %}
                    {% for category,message in messages %}
                        <div class="alert alert-{{ category }}">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            <div class="panel-heading">
                <h3 class="panel-title">图片管理中心</h3>
            </div>
            <div class="panel-body">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th style="width: 15%">略缩图</th>
                            <th>文件名</th>
                            <th style="width: 15%">操作</th>
                        </tr>
                    </thead>

                    <tbody>
                    {% for image in images %}
                        <tr id="image-row-{{ image.filename.replace('.','-') }}">
                        <td><img src="{{ url_for('static',filename='images/' + image.filename) }}" alt="略缩图" class="img-thumbnail" width="100"></td>
                        <td>{{ image.filename }}</td>
                        <td>
                           <button class="btn btn-danger" data-filename="{{ image.filename }}">删除</button>
                        </td>
                    {% endfor %}
                </table>
            </div>
        </div>
    </div>

    <script>
    $(document).ready(function(){
        $('.btn.btn-danger').click(function(){
            let filenameToDelete = $(this).data("filename");
            if (confirm("你确定要删除"+filenameToDelete+"吗？")) {
                $.post("{{ url_for('delete_image') }}",{filename:filenameToDelete},function(response){
                    if (response.status == 'success'){
                        let rowId = '#image-row-' + filenameToDelete.replace('.','-');
                        $(rowId).fadeOut('slow', function(){
                            $(this).remove();})
                        } else {
                            alert('删除失败'+response.message)
                    }
                });
            }
        });
    });
    </script>

{% endblock %}